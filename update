#!/usr/bin/env bash

set -u -o pipefail
# Do not exit if one command failed
# set -e
# set -x

main() {
	local SYSTEM=false
	if [[ "${#}" -gt 0 ]]; then
		case "${1}" in
			"s"|"sy"|"sys"|"syst"|"syste"|"system")
				SYSTEM=true
				;;
		esac
	fi

	local OSTREE=false
	if [[ -f "/run/ostree-booted" ]]; then
		OSTREE=true
	fi

	if [[ "${SYSTEM}" == true ]] && [[ "${OSTREE}" == false ]] && [[ -z "${TMUX+x}" ]]; then
		tmux attach-session -t update || tmux new-session -s update -- ~/.local/bin/+update system
		exit 0
	fi

	if [[ "${SYSTEM}" == true ]]; then
		if [[ "${OSTREE}" == true ]]; then
			echo "[+] Updating system (rpm-ostree)..."
			rpm-ostree update
		else
			echo "[+] Updating system (dnf)..."
			sudo dnf update --refresh
		fi
	fi

	# local -r release="34"
	# local -r toolbox="fedora-toolbox-${release}"
	# TODO: Update for Quay.io based toolbox
	# toolbox run --container "${toolbox}" sudo dnf distro-sync -y

	echo "[+] Updating toolbox..."
	# 'quay.io/travier/toolbox-texlive:latest'
	images=(
		'quay.io/travier/toolbox:latest'
	)
	for img in "${images[@]}"; do
		podman pull "${img}"
		local tbx="toolbox" # TODO: keep only image name
		toolbox rm --force "${tbx}"
		toolbox create --image "${img}" "${tbx}"
	done

	echo "[+] Updating system Flatpaks..."
	flatpak --system update --assumeyes
	flatpak --system remove --unused --assumeyes

	echo "[+] Updating Rust crates..."
	rustup update
	toolbox run --container 'toolbox' ~/.cargo/bin/cargo install-update -a
	toolbox run --container 'toolbox' ~/.cargo/bin/cargo cache -a

	echo "[+] Done!"
	if [[ -n "${TMUX+x}" ]]; then
		exec "${SHELL}"
	fi
}

main "${@}"
